/**
 * The configuration file handling module
 *
 * function load 读取ini配置文件内容
 */
var fs = require('fs');
var querystring = require("querystring");

/**
 * Read the INI file
 *
 * @param {String} filename
 * returns {Object}
 */
exports.load = function (filename) {
    var file = (require("fs").readFileSync(filename)+'').replace(/#.*?(\r|\n)/g,'$1'),
        classify = querystring.parse(file, '[', ']');
    //过滤空配置以及解析配置键值
    for(var p in classify){
        (p == '' || classify[p] == '') ?
            delete classify[p] :
            (function(){
                var t = classify[p]
                    .split(/(\r\n|\n\r|\r|\n)/g);
                classify[p] = t
                    .map(function(a){
                         a = a.replace(/(\r|\n)/g,'');
                        return querystring
                            .parse(
                                a.replace(/\s*?\=\s*/g,'=')
                            );
                    })
                    .reduce(harbors.utils.merge);
            })();
    }
    return classify;
};
