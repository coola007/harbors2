exports.analysis = function(request,next){

    request.req.headers.cookie ?
        (function(){
            if(!request.req.headers.cookie){
                return {};
            }
            var temp = request.req.headers.cookie.split(";");
            var cookie = {};
            for(var i=0;i<temp.length;i++){
                var temp_2 = temp[i].split("=");
                temp_2[0] = temp_2[0].replace(/^\s*/,'');
                cookie[temp_2[0]] = temp_2[1];
            }
            request._cookie = cookie;
        })() :
        request._cookie = {};

    if(request.config.session=='false'){
        request._session = {};
        next();
        return undefined;
    }

    var sId = request.cookie(request.config.session_id);
    if(!sId){
        request._session = {};
        next();
        return undefined;
    }

    switch(request.config.session_module){
        case 'file':
            next();
            break;
        default:
            var name = request.path.vhostName+'_'+sId;
            harbors._session[name] ?
                request._session = harbors._session[name] :
                request._session = {};
            next();
            break;
    }
};


exports.set = function(arg,self){
    switch(self.config.session_module){
        case 'file':

        default ://mem
            var dName = self.path.vhostName+'_'+self._sCookie;
            if(!harbors._session[dName])
                harbors._session[dName] = {};
            harbors._session[dName][arg[0]] = arg[1];
            //清除过期计数器
            clearTimeout(harbors._sessionTimer[dName]);
            //记录过期删除时间
            harbors._sessionTimer[dName] = setTimeout(function(){
                delete harbors._session[dName][arg[0]];
            },self.config.session_survavil);
            break;
    }
};