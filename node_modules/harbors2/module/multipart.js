var _l_utils = require('../lib/utils');
var multiparty = require('multiparty');
var qs = require('qs');

module.exports = function(request,next){
    var limit = request.config.upload_size || 2048*1024;

    //已执行过，或为get请求，并且存在
    if (
        request._post ||
        request.req.method == 'GET' ||
        request.req.method == 'HEAD' ||
        _l_utils.mime(request.req) != 'multipart/form-data'
    ){
        next();
        return;
    }

    request._post = {};
    request._files = {};

    function ondata(name, val, data){
        if (Array.isArray(data[name])) {
            data[name].push(val);
        } else if (data[name]) {
            data[name] = [data[name], val];
        } else {
            data[name] = val;
        }
    }

    var form = new multiparty.Form()
        , data = {}
        , files = {}
        , done;
    form.on('field', function(name, val){
        ondata(name, val, data);
    });

    form.on('file', function(name, val){
        val.name = val.originalFilename;
        val.type = val.headers['content-type'] || null;
        ondata(name, val, files);
    });

    form.on('error', function(err){
        if (!options.defer) {
            err.status = 400;
            next(err);
        }
        done = true;
    });


    form.on('close', function(){
        if (done) return;
        try {
            request._post = qs.parse(data);
            request._files = qs.parse(files);
        } catch (err) {
            form.emit('error', err);
            return;
        }finally{
            next();
        }
    });


    form.parse(request.req);
};